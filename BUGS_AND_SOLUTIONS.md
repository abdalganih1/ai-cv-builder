# ุณุฌู ุงููุดุงูู ูุงูุญููู - AI CV Builder

> ููู ุชูุซูู ูุฌููุน ุงููุดุงูู ุงูุชู ูุงุฌููุง ุงููุดุฑูุน ูููู ุชู ุญููุงุ ูููุน ุชูุฑุงุฑูุง.

---

## ๐ ููุฑุณ ุงููุดุงูู

| #   | ุงููุดููุฉ                                                                                                  | ุงููุณู  | ุงูุฎุทูุฑุฉ    | ุงูุญุงูุฉ    |
| --- | -------------------------------------------------------------------------------------------------------- | ------ | ---------- | --------- |
| 1   | [Race condition ุนูุฏ ุงูุฑุฌูุน ุจุงูุชููู](#1-race-condition-ุนูุฏ-ุงูุฑุฌูุน-ุจุงูุชููู)                                | ุงูุชููู | ๐ด ุนุงููุฉ   | โ ูุญููู  |
| 2   | [getQuestionForField ูุง ูุฏุนู ุงูุญููู ุงููุตููููุฉ](#2-getquestionforfield-ูุง-ูุฏุนู-ุงูุญููู-ุงููุตููููุฉ)           | ุงูุชููู | ๐ด ุนุงููุฉ   | โ ูุญููู  |
| 3   | [ููุฏุงู ุงูููุถุน ุนูุฏ ุงูุฎุฑูุฌ ูุงูุนูุฏุฉ ููุงุณุชุจูุงู](#3-ููุฏุงู-ุงูููุถุน-ุนูุฏ-ุงูุฎุฑูุฌ-ูุงูุนูุฏุฉ-ููุงุณุชุจูุงู)               | ุงูุชููู | ๐ก ูุชูุณุทุฉ  | โ ูุญููู  |
| 4   | [ุบูุงุจ checkpoints ููุชููู ุงููุฑุฆู](#4-ุบูุงุจ-checkpoints-ููุชููู-ุงููุฑุฆู)                                      | ูุงุฌูุฉ  | ๐ก ูุชูุณุทุฉ  | โ ูุญููู  |
| 5   | [ุญุฐู ุงูุจูุงูุงุช ุนูุฏ ุงูุชููู ุฑุฌูุนุงู ุซู ุฃูุงูุงู](#5-ุญุฐู-ุงูุจูุงูุงุช-ุนูุฏ-ุงูุชููู-ุฑุฌูุนุงู-ุซู-ุฃูุงูุงู)                 | ุงูุชููู | ๐ด ุนุงููุฉ   | โ ูุญููู  |

---

## ุงูุชูุงุตูู

### 1. Race condition ุนูุฏ ุงูุฑุฌูุน ุจุงูุชููู

**ุงูุนูุฑูุถ:** ุนูุฏ ุฅุฏุฎุงู ุงูููุงููุฏ (birthDate) ูุงูุถุบุท ุนูู "ุฑุฌูุน"ุ ูุชู ุชุฌุงูุฒ ุณุคุงู ุงูููุงููุฏ ูุงูุนูุฏุฉ ูุจุงุดุฑุฉ ูุฑูู ุงููุงุชู (ุฎุทูุฉ Contact).

**ุงูุณุจุจ ุงูุฌุฐุฑู:**

- `handleInternalBack()` ูุณุชุฏุนู `setIsRewinding(true)` (setState - ุชุญุฏูุซ ุบูุฑ ููุฑู)
- ุซู ูุณุชุฏุนู `onUpdate(clearData)` ุงูุฐู ููุบููุฑ `data`
- ุชุบููุฑ `data` ููุนูุฏ ุชุดุบูู `useEffect` ูุฌูุจ ุงูุณุคุงู ุงูุชุงูู
- `useEffect` ููุฑุฃ ูููุฉ `isRewinding` ูู ุงูู closure ุงููุฏููุฉ (= `false`)
- ููุชุฌุงูุฒ ุงูุญูุงูุฉ ููุฌูุจ ุงูุณุคุงู ุงูุชุงูู ุจุฏูุงู ูู ุงูุจูุงุก ุนูู ุงูุณุคุงู ุงููุนููู ูุฏููุงู

**ุงูุญู:**

```tsx
// ุงุณุชุฎุฏุงู useRef ุจุฌุงูุจ useState ูุถูุงู ูุฑุงุกุฉ ููุฑูุฉ
const isRewindingRef = useRef(false);
const setRewindingState = (val: boolean) => {
    isRewindingRef.current = val; // ุชุญุฏูุซ ููุฑู (synchronous)
    setIsRewinding(val);         // ุชุญุฏูุซ React (async)
};

// ูู useEffect: ูุญุต ุงูู ref ุฃููุงู (ููุฑู) ุซู ุงูู state
useEffect(() => {
    const fetchQuestion = async () => {
        if (isRewindingRef.current || isRewinding) return;
        // ...
        // ูุญุต ุซุงูู ุจุนุฏ ุงูุนูููุฉ ุงูู async
        if (isRewindingRef.current) return;
        setCurrentQuestion(question);
    };
    fetchQuestion();
}, [data, isRewinding]);
```

**ุงูููู ุงููุนุฏูู:** `src/components/wizard/QuestionnaireStep.tsx`
**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 2026-02-13

> โ๏ธ **ูุงุนุฏุฉ ุนุงูุฉ:** ูู ุฃู ููุงู ูุชู ููู ุชุนููู state ููุณุชุฎุฏู ูุญูุงูุฉ ูู useEffectุ ูุฌุจ ุงุณุชุฎุฏุงู useRef ุจุฌุงูุจ useState ูููุน race conditions.

---

### 2. getQuestionForField ูุง ูุฏุนู ุงูุญููู ุงููุตููููุฉ

**ุงูุนูุฑูุถ:** ุนูุฏ ุงูุฑุฌูุน ูุณุคุงู ูู ูุณู ุงูุชุนููู ุฃู ุงูุฎุจุฑุงุช ุฃู ุงููุบุงุชุ ูุง ูุธูุฑ ุงูุณุคุงู ููุง ุงููููุฉ ุงููุฎุฒูุฉ.

**ุงูุณุจุจ ุงูุฌุฐุฑู:**

- ุงูุฏุงูุฉ ุงููุฏููุฉ `getQuestionForField()` ูู `QuestionnaireStep` ูุงูุช ุชุฏุนู ููุท ุงูุญููู ุงูุดุฎุตูุฉ ุงูุจุณูุทุฉ
- ูู ููู ููุงู ุฏุนู ูุญููู ูุซู `education_institution`ุ `experience_company`ุ `languages_name`
- ูุฐู ุงูุญููู ุชุญุชุงุฌ `entryIndex` ููุนุฑูุฉ ุฃู ุนูุตุฑ ูู ุงููุตูููุฉ ููุดุงุฑ ุฅููู

**ุงูุญู:**

- ุฅุถุงูุฉ `getQuestionForFieldDirect(field, data, entryIndex)` ูู `questionnaire-agent.ts`
- ุชุฏุนู **ุฌููุน** ุฃููุงุน ุงูุญููู ูุน ุงูุณูุงู ุงูููุงุณุจ (ูุซู ุงุณู ุงูุฌุงูุนุฉ/ุงูุดุฑูุฉ)
- ุฅุถุงูุฉ `populateResponseForField()` ูุงุณุชุฑุฌุงุน ุงูููู ุงููุฎุฒูุฉ ููู ููุน ุญูู

**ุงููููุงุช ุงููุนุฏููุฉ:**

- `src/lib/ai/questionnaire-agent.ts` (ุฅุถุงูุฉ ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ)
- `src/components/wizard/QuestionnaireStep.tsx` (ุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ)
**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 2026-02-13

> โ๏ธ **ูุงุนุฏุฉ ุนุงูุฉ:** ุฃู ุฏุงูุฉ ุชุชุนุงูู ูุน ุญููู ุงูุงุณุชุจูุงู ูุฌุจ ุฃู ุชุฏุนู ุฌููุน ุฃููุงุน ุงูุญููู (ุดุฎุตูุฉ + ูุตููููุฉ) ูุฃู ุชูุฑุฑ `entryIndex` ุนูุฏ ุงูุญุงุฌุฉ.

---

### 3. ููุฏุงู ุงูููุถุน ุนูุฏ ุงูุฎุฑูุฌ ูุงูุนูุฏุฉ ููุงุณุชุจูุงู

**ุงูุนูุฑูุถ:** ุนูุฏ ุงูุฎุฑูุฌ ูู ุฎุทูุฉ ุงูุงุณุชุจูุงู (ุฑุฌูุน ูู Contact) ูุงูุนูุฏุฉ ุฅูููุงุ ูุง ูููู ุงูุฑุฌูุน ูููุฏุฎูุงุช ุงููุฏููุฉ.

**ุงูุณุจุจ ุงูุฌุฐุฑู:**

- ุนูุฏ ุฅุนุงุฏุฉ ุชุญููู ุงููููู (`QuestionnaireStep`)ุ ูุจุฏุฃ ุจู `questionHistory = []`
- `initializeHistoryFromData()` ุชุจูู History ูู ุงูุจูุงูุงุช ุงููุญููุธุฉ
- ููููุง ูู ุชูู ุชุดูู ูู ุงูุญููู ุจุดูู ุตุญูุญ

**ุงูุญู:**

- ุฅุนุงุฏุฉ ูุชุงุจุฉ `initializeHistoryFromData()` ูุชุดูู ุฌููุน ุงูุญููู ูุงููุตูููุงุช
- ุชุดุบูููุง ูุฑุฉ ูุงุญุฏุฉ ุนูุฏ ุฃูู mount ููุท
- ุจูุฐุง ูููู ูููุณุชุฎุฏู ุงูุฑุฌูุน ุนุจุฑ ูู ุงูุฃุณุฆูุฉ ุงูููุฌุงุจุฉ ุณุงุจูุงู

**ุงูููู ุงููุนุฏูู:** `src/components/wizard/QuestionnaireStep.tsx`
**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 2026-02-13

---

### 4. ุบูุงุจ checkpoints ููุชููู ุงููุฑุฆู

**ุงูุนูุฑูุถ:** ูุง ููุฌุฏ ุทุฑููุฉ ูุฑุฆูุฉ ููููุฒ ุจูู ุฃูุณุงู ุงูุงุณุชุจูุงู (ุงูุชุนููู โ ุงูุฎุจุฑุงุช โ ุฅูุฎ).

**ุงูุญู:**

- ุฅุถุงูุฉ ุดุฑูุท checkpoints ุฃููู ูุงุจู ููููุฑ (6 ุฃูุณุงู: ๐ค๐๐ผโก๐๐ฏ)
- ูู checkpoint ูู ุญุงูุฉ: ููุชูู (ุฃุฎุถุฑ) / ูุดุท (ุฃุฒุฑู) / ูููู (ุฑูุงุฏู)
- ุงูููุฑ ุนูู checkpoint ููุชูู ูุฃุฎุฐู ูุฃูู ุณุคุงู ููู
- `navigateToSection()` ุชูุนูุฏ ุจูุงุก History ูุชูููู ูุจุงุดุฑุฉ

**ุงูููู ุงููุนุฏูู:** `src/components/wizard/QuestionnaireStep.tsx`
**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 2026-02-13

---

### 5. ุญุฐู ุงูุจูุงูุงุช ุนูุฏ ุงูุชููู ุฑุฌูุนุงู ุซู ุฃูุงูุงู

**ุงูุนูุฑูุถ:** ุงูุฑุฌูุน ูุฑุชูู ูู `education_endYear` โ `education_startYear` โ `education_major`ุ ุซู ุงูุชูุฏู. ุงูุจูุงูุงุช ูู `education_major` ู `education_endYear` ุชูุญุฐู.

**ุงูุณุจุจ ุงูุฌุฐุฑู:**

- ุนูุฏ ุงูุชูุฏู ุจุนุฏ ุงูุฑุฌูุนุ `handleAnswer` ูุณุชุฏุนู `setResponse('')` ููุณุญ ุงูุญูู
- `useEffect` ูุฌูุจ ุงูุณุคุงู ุงูุชุงูู ูููู ูุง ูููุฃ ุงูุญูู ุจุงููููุฉ ุงููุฎุฒูุฉ
- ุฅุฐุง ุถุบุท ุงููุณุชุฎุฏู "ูุชุงุจุนุฉ" ุนูู ุญูู ูุงุฑุบ โ `list[idx].major = ''` ููุชุจ ููู ุงููููุฉ ุงูููุฌูุฏุฉ

**ุงูุญู (ุทุจูุชูู):**

```tsx
// ุทุจูุฉ 1: ููุก ุชููุงุฆู - useEffect ูููุฃ ุงูุญูู ุจุงููููุฉ ุงููุฎุฒูุฉ
useEffect(() => {
    // ... fetch question ...
    if (question) {
        const entryIdx = getEntryIndexForField(question.field);
        populateResponseForField(question.field, entryIdx); // โ ุฌุฏูุฏ
    }
}, [data, isRewinding]);

// ุทุจูุฉ 2: ุญูุงูุฉ - ูุง ุชูุชุจ ููู ุจูุงูุงุช ููุฌูุฏุฉ ุจูููุฉ ูุงุฑุบุฉ
if (list.length > idx && response) list[idx].major = response;
//                       ^^^^^^^^ guard: ููุท ุงูุชุจ ุฅุฐุง response ุบูุฑ ูุงุฑุบ
```

**ุงูููู ุงููุนุฏูู:** `src/components/wizard/QuestionnaireStep.tsx`
**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 2026-02-13

> โ๏ธ **ูุงุนุฏุฉ ุนุงูุฉ:** ูุง ุชูุชุจ ุฃุจุฏุงู ูููุฉ ูุงุฑุบุฉ ููู ุจูุงูุงุช ููุฌูุฏุฉ ูู ุญููู ุงููุตูููุงุช. ูุงููุฃ ุงูุญูู ุชููุงุฆูุงู ุจุงููููุฉ ุงููุฎุฒูุฉ ุนูุฏ ุนุฑุถ ุฃู ุณุคุงู.

---

## ๐ ุฃููุงุท ุงููุดุงูู ุงููุชูุฑุฑุฉ (ูุฌุจ ูุฑุงุฌุนุชูุง ุฏุงุฆูุงู)

### ููุท 1: Race Conditions ูุน useEffect

```
โ ุงููุดููุฉ: setState(true) + onUpdate(data) โ useEffect ููุฑุฃ ุงููููุฉ ุงููุฏููุฉ
โ ุงูุญู: ุงุณุชุฎุฏุงู useRef ุจุฌุงูุจ useState
```

### ููุท 2: ุญููู ูุตููููุฉ ุจุฏูู entryIndex

```
โ ุงููุดููุฉ: ุงูุชุนุงูู ูุน education_institution ุจุฏูู ูุนุฑูุฉ ุฃู ุนูุตุฑ
โ ุงูุญู: ุฏุงุฆูุงู ุชุชุจุน activeEntryIndex ูุชูุฑูุฑู ูุน ูู ุนูููุฉ
```

### ููุท 3: ููุฏุงู ุงูุญุงูุฉ ุนูุฏ unmount/remount

```
โ ุงููุดููุฉ: ุงููููู ูููุฏ state ุนูุฏ ุงูุฎุฑูุฌ ูุงูุนูุฏุฉ
โ ุงูุญู: ุจูุงุก ุงูุญุงูุฉ ูู ุงูุจูุงูุงุช ุงููุญููุธุฉ ุนูุฏ ุฃูู mount
```

### ููุท 4: ุงููุชุงุจุฉ ููู ุจูุงูุงุช ููุฌูุฏุฉ ุจูููุฉ ูุงุฑุบุฉ

```
โ ุงููุดููุฉ: handleAnswer ููุชุจ response ูุงุฑุบ ููู ุจูุงูุงุช ูุฎุฒูุฉ
โ ุงูุญู: guard condition (response && ...) + auto-populate ูู ุงูุจูุงูุงุช ุงููุญููุธุฉ
```
